<div class="w-full h-screen flex items-center justify-center" 
    x-data="{
        selectedPivot: {},
        bShowRegisterPivotModal: false
    }">
    <div class="lg:w-[60%] xl:w-[50%] p-10">
        <div class="flex items-center gap-2 mb-6"
            x-data="{ open: false, pivots: [] }"
            x-init="async () => {
                    try {
                        const res = await fetch(`${API_URL}/api/get_user_pivots?user_id=${user_id}`);
                        pivots = await res.json();
                    } catch (err) {
                        console.error('Failed to load pivots', err);
                    }
                }">

            <div class="relative flex-1" x-data="{ open: false }">
                <button 
                    id="pivotSelect" 
                    @click="open = !open"
                    @click.away="open = false"
                    class="w-full flex justify-between items-center border rounded px-3 py-1 cursor-pointer bg-white"
                    type="button">
                    <span x-text="selectedPivot?.name || 'Select Pivot'"></span>
                    <img :src="'../icons/chevron_down.svg'" class="w-5" :class="open && 'rotate-180'">
                </button>

                <div 
                    x-show="open" 
                    x-transition
                    class="absolute z-10 top-full left-0 w-full mt-1 bg-white border border-default-medium rounded-lg shadow-lg"
                    style="display: none;"
                >
                    <ul class="p-2 text-sm font-medium">
                        <template x-for="pivot in pivots" :key="pivot.id">
                            <li>
                                <button 
                                    @click="selectedPivot = pivot; open = false" 
                                    class="inline-flex items-center w-full p-2 hover:bg-neutral-tertiary-medium rounded text-left"
                                    x-text="pivot.name">
                                </button>
                            </li>
                        </template>
                        
                        <template x-if="pivots.length === 0">
                            <li class="p-2 text-gray-400 italic">No pivots found</li>
                        </template>
                    </ul>
                </div>
            </div>

            <button class="self-stretch bg-green-500 text-white px-4 rounded cursor-pointer" @click="bShowRegisterPivotModal = true">
                <img :src="'../icons/plus.svg'" class="w-5">
            </button>
        </div>

        <!-- Start/Stop button -->
        <button 
            x-data="{ 
                get command() { 
                    return selectedPivot?.status?.state === 'Running' ? 'Stop' : 'Start' 
                } 
            }"
            @click="
                if(!selectedPivot) return;
                const response = await fetch(`${API_URL}/api/command`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded'},
                    body: new URLSearchParams({
                        pivot_id: selectedPivot.id,
                        command: command
                    })
                });
            "
            x-text="command"
            :class="selectedPivot?.status?.state === 'Running' ? 'bg-red-500' : 'bg-blue-500'"
            class="w-full text-white py-2 rounded mb-6 text-lg font-bold cursor-pointer disabled:opacity-50"
            :disabled="!selectedPivot">
        </button>

        <div class="w-full flex items-center justify-center py-5">
            <pie-chart></pie-chart>
        </div>
        
        <!-- Status cards -->
        <div 
            x-data="{ 
                statusData: {},
                formatLabel(key) {
                    return key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                }
            }" 
            x-effect="
                if (selectedPivot?.id) {
                    try {
                        let res = await fetch(`${API_URL}/api/pivot_status?pivot_id=${selectedPivot.id}`);
                        if (res.ok) {
                            statusData = await res.json();
                        }
                    } catch(err) {
                        console.error('Status fetch error:', err);
                    }
                }
            "
            class="grid grid-cols-2 md:grid-cols-3 gap-4">

            <template x-for="(value, key) in statusData" :key="key">
                <template x-if="key !== 'pivot_id' && key !== 'id'">
                    <div x-data="{heading: formatLabel(key), body: value}">
                        <status-card></status-card>
                    </div>
                </template>
            </template>

        </div>

    </div>  

    <div x-data="{
        get bShow() { return bShowRegisterPivotModal }, 
        set bShow(val) { bShowRegisterPivotModal = val }
    }">
        <register-pivot-modal/>
    </div>
</div>


